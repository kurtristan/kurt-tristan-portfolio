<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kurt Tristan — Portfolio</title>
  <meta name="description" content="Photography portfolio and journal by Kurt Tristan." />
  <style>
    :root{
      --ink:#2c2c2c;--muted:#666;--accent:#8A9A8E;--paper:#fff;--bg:#f5f5f5;--line:#ddd;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{padding:28px 18px;background:var(--accent);color:#fff}
    header .wrap{max-width:1100px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    a{color:inherit}
    main{max-width:1100px;margin:30px auto;padding:0 18px}
    h1,h2,h3{margin:0 0 10px}
    .section{background:var(--paper);border:1px solid var(--line);border-radius:14px;margin:18px 0;padding:18px}
    .sub{color:#fff;opacity:.8;font-size:.9rem}
    .divider{height:1px;background:var(--line);margin:16px 0}

    /* Gallery */
    #gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
    figure.photo{margin:0;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#fafafa;display:flex;flex-direction:column}
    figure.photo img{width:100%;height:220px;object-fit:cover;display:block;background:#eee}
    figure.photo figcaption{padding:12px 12px 14px}
    figure.photo h3{font-size:1.05rem;margin:0 0 6px}
    .caption{color:var(--muted);margin:0 0 6px;font-size:.95rem}
    .meta{color:#7a7a7a;margin:2px 0;font-size:.9rem}

    /* Journal */
    #journal .entry{border:1px solid var(--line);border-radius:12px;padding:14px;background:#fff}
    #journal h3{margin:0 0 6px}
    #journal .date{color:var(--accent);font-weight:600;margin:0 0 8px}
    #journal .content{color:var(--muted);line-height:1.6;white-space:pre-wrap}

    /* Helpers */
    .loading{color:#888}
    .error{color:#c00}
    footer{max-width:1100px;margin:20px auto 40px;padding:0 18px;color:#777}
    @media (max-width:640px){figure.photo img{height:200px}}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div>
        <h1 style="margin:0">Kurt Tristan</h1>
        <div class="sub">Photography · Journal</div>
      </div>
      <nav>
        <a href="/admin" style="text-decoration:none">Admin</a>
      </nav>
    </div>
  </header>

  <main>
    <!-- Gallery Section -->
    <section class="section">
      <h2>Gallery</h2>
      <div class="divider"></div>
      <div id="gallery-status" class="loading">Loading photos…</div>
      <div id="gallery" aria-live="polite"></div>
      <noscript><p class="error">Enable JavaScript to view the gallery.</p></noscript>
    </section>

    <!-- Journal Section -->
    <section class="section">
      <h2>Journal</h2>
      <div class="divider"></div>
      <div id="journal-status" class="loading">Loading journal…</div>
      <div id="journal" aria-live="polite" style="display:grid;gap:12px"></div>
      <noscript><p class="error">Enable JavaScript to view journal entries.</p></noscript>
    </section>
  </main>

  <footer>
    © <span id="year"></span> Kurt Tristan
  </footer>

  <script>
    // Utils
    function esc(s){return String(s==null?'':s).replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
    function fmtDate(d){
      if(!d) return '';
      try{
        const dt = new Date(d.length>10 ? d : d + 'T00:00:00');
        return dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
      }catch{ return d; }
    }

    // GALLERY
    async function renderGalleryPublic(){
      const box = document.getElementById('gallery');
      const status = document.getElementById('gallery-status');
      try{
        const res = await fetch('/.netlify/functions/gallery', { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const photos = await res.json();

        if(!Array.isArray(photos) || photos.length===0){
          status.textContent = 'No photos yet.';
          box.innerHTML = '';
          return;
        }
        status.textContent = '';

        box.innerHTML = photos.map(p=>{
          const img = esc(p.image_url || p.src || '');
          const title = esc(p.title || p.filename || 'Untitled');
          const caption = esc(p.caption || '');
          const camera = esc(p.camera || '—');
          const film = esc(p.film || '—');
          const location = esc(p.location || '—');

          return `
            <figure class="photo">
              <img loading="lazy" src="${img}" alt="${title}" />
              <figcaption>
                <h3>${title}</h3>
                ${caption ? `<p class="caption">${caption}</p>` : ''}
                <p class="meta">Camera: ${camera} · Film: ${film}</p>
                <p class="meta">Location: ${location}</p>
              </figcaption>
            </figure>
          `;
        }).join('');
      }catch(err){
        console.error(err);
        status.innerHTML = '<span class="error">Failed to load gallery.</span>';
      }
    }

    // JOURNAL
    async function renderJournalPublic(){
      const box = document.getElementById('journal');
      const status = document.getElementById('journal-status');
      try{
        const res = await fetch('/.netlify/functions/journal', { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const entries = await res.json();

        if(!Array.isArray(entries) || entries.length===0){
          status.textContent = 'No journal entries yet.';
          box.innerHTML = '';
          return;
        }
        status.textContent = '';

        box.innerHTML = entries.map(e=>{
          const title = esc(e.title || 'Untitled');
          const date = esc(e.entry_date || e.date || '');
          const content = esc(e.content || '');
          return `
            <article class="entry">
              <h3>${title}</h3>
              <div class="date">${fmtDate(date)}</div>
              <div class="content">${content}</div>
            </article>
          `;
        }).join('');
      }catch(err){
        console.error(err);
        status.innerHTML = '<span class="error">Failed to load journal.</span>';
      }
    }

    // Boot
    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('year').textContent = new Date().getFullYear();
      renderGalleryPublic();
      renderJournalPublic();
    });
  </script>
</body>
</html>
